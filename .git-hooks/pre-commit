#!/bin/bash
# Hive Project - Enhanced Pre-commit Hook
# Based on ../beaver project git-hooks best practices

set -e

echo "ğŸª Pre-commit ãƒ•ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆç¦æ­¢
if [ "$current_branch" = "main" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ç›´æ¥ã‚³ãƒŸãƒƒãƒˆã¯ç¦æ­¢ã•ã‚Œã¦ã„ã¾ã™"
    echo ""
    echo "   ğŸ”„ æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„:"
    echo "   git checkout -b feat/your-feature-name"
    echo ""
    echo "   ğŸ“‹ Hiveãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡:"
    echo "   - feat/issue-X-feature-name     (æ–°æ©Ÿèƒ½)"
    echo "   - fix/issue-X-description       (ãƒã‚°ä¿®æ­£)"
    echo "   - docs/X-description            (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)"
    echo "   - refactor/X-description        (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°)"
    echo "   - test/X-description            (ãƒ†ã‚¹ãƒˆ)"
    echo "   - ci/X-description              (CI/CD)"
    echo "   - claude/X-description          (Claude Codeä½œæ¥­)"
    echo ""
    exit 1
fi

# ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ï¼‰
if [ "$current_branch" != "main" ]; then
    valid_patterns="^(feat|fix|hotfix|test|docs|ci|cicd|refactor|perf|security|deps|claude)/"
    if ! echo "$current_branch" | grep -qE "$valid_patterns"; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“: $current_branch"
        echo ""
        echo "   ğŸ“‹ æ­£ã—ã„ãƒ–ãƒ©ãƒ³ãƒå‘½åå½¢å¼:"
        echo "   - feat/issue-X-feature-name     (æ–°æ©Ÿèƒ½)"
        echo "   - fix/issue-X-description       (ãƒã‚°ä¿®æ­£)"
        echo "   - docs/X-description            (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)"
        echo "   - refactor/X-description        (ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°)"
        echo "   - test/X-description            (ãƒ†ã‚¹ãƒˆ)"
        echo "   - ci/cicd/X-description         (CI/CD)"
        echo "   - perf/X-description            (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹)"
        echo "   - security/X-description        (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)"
        echo "   - deps/X-description            (ä¾å­˜é–¢ä¿‚)"
        echo "   - claude/X-description          (Claude Codeä½œæ¥­)"
        echo ""
        echo "   ğŸ”„ ãƒ–ãƒ©ãƒ³ãƒåã‚’å¤‰æ›´ã™ã‚‹ã«ã¯:"
        echo "   git branch -m $current_branch feat/issue-X-description"
        echo ""
        exit 1
    fi
fi

# ç©ºã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
if [ -z "$(git diff --cached --name-only)" ]; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
    echo "   git add <files> ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
    exit 1
fi

# ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
staged_files=$(git diff --cached --name-only)
echo "ğŸ“ ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
echo "$staged_files" | sed 's/^/   /'
echo ""

# Pythonå›ºæœ‰ãƒã‚§ãƒƒã‚¯
python_files=$(git diff --cached --name-only | grep "\.py$" || true)
if [ -n "$python_files" ]; then
    echo "ğŸ Pythonå›ºæœ‰ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
    
    # __pycache__ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if echo "$staged_files" | grep -q "__pycache__"; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: __pycache__ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™"
        echo "   git reset HEAD **/__pycache__/ ã§é™¤å¤–ã—ã¦ãã ã•ã„"
        exit 1
    fi
    
    # .pycãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
    if echo "$staged_files" | grep -q "\.pyc$"; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: .pycãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚Œã¦ã„ã¾ã™"
        echo "   git reset HEAD **/*.pyc ã§é™¤å¤–ã—ã¦ãã ã•ã„"
        exit 1
    fi
fi

# Makefileã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆ
makefile_changed=$(git diff --cached --name-only | grep -E '^Makefile$' || true)
if [ -n "$makefile_changed" ]; then
    echo "ğŸ”§ Makefileæ§‹æ–‡ãƒã‚§ãƒƒã‚¯..."
    if ! make -n help >/dev/null 2>&1; then
        echo "âŒ ã‚¨ãƒ©ãƒ¼: Makefileæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
        exit 1
    fi
    echo "âœ… Makefileæ§‹æ–‡ãƒã‚§ãƒƒã‚¯å®Œäº†"
fi

# å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ10MBä»¥ä¸Šï¼‰
large_files=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ] && [ $(stat -f%z "{}" 2>/dev/null || stat -c%s "{}" 2>/dev/null || echo 0) -gt 10485760 ]; then echo "{}"; fi' || true)
if [ -n "$large_files" ]; then
    echo "âš ï¸ è­¦å‘Š: å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ10MBä»¥ä¸Šï¼‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:"
    echo "$large_files" | sed 's/^/   /'
    echo "   Git LFSã®ä½¿ç”¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„"
    echo ""
fi

# æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
echo "ğŸ”’ æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯ä¸­..."
sensitive_patterns="(password|secret|token|key|api_key|private_key)"
if git diff --cached | grep -iE "$sensitive_patterns" >/dev/null 2>&1; then
    echo "âš ï¸ è­¦å‘Š: æ©Ÿå¯†æƒ…å ±ã®å¯èƒ½æ€§ãŒã‚ã‚‹æ–‡å­—åˆ—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
    echo "   ã‚³ãƒŸãƒƒãƒˆå‰ã«å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    echo ""
fi

# å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
echo "ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
if ! make quality >/dev/null 2>&1; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: å“è³ªãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ"
    echo "   make quality ã‚’å®Ÿè¡Œã—ã¦å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
    echo ""
    echo "   ğŸ’¡ è‡ªå‹•ä¿®æ­£ã‚’è©¦ã™ã«ã¯:"
    echo "   make quality-fix"
    echo ""
    exit 1
fi

# Phase 1ã§ã¯ãƒ†ã‚¹ãƒˆã¯åŸºæœ¬ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
echo "ğŸ§ª åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
if ! make test >/dev/null 2>&1; then
    echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
    echo "   make test ã‚’å®Ÿè¡Œã—ã¦å•é¡Œã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"
    exit 1
fi

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯ï¼ˆå°†æ¥ã®commit-msgãƒ•ãƒƒã‚¯æº–å‚™ï¼‰
commit_msg_pattern="^(feat|fix|docs|style|refactor|test|chore|ci)(\(.+\))?: .{1,50}"
echo ""
echo "ğŸ’¡ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ’ãƒ³ãƒˆ:"
echo "   Conventional Commitså½¢å¼ã‚’æ¨å¥¨ã—ã¾ã™:"
echo "   feat(queen): add multi-agent coordination"
echo "   fix(comb): resolve file locking issue"
echo ""

echo "âœ… Pre-commit ãƒã‚§ãƒƒã‚¯å®Œäº†"
echo "ğŸš€ ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™..."